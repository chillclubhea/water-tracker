<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase + Netlify æ•´åˆæ¸¬è©¦</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 800px; 
            margin: 50px auto; 
            padding: 20px; 
            background: #f5f5f5;
        }
        .container { 
            background: white; 
            border-radius: 10px; 
            padding: 30px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section { 
            margin: 20px 0; 
            padding: 20px; 
            border: 1px solid #ddd; 
            border-radius: 8px; 
        }
        button { 
            background: #3498db; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            margin: 5px; 
            border-radius: 5px; 
            cursor: pointer; 
        }
        button:hover { background: #2980b9; }
        .result { 
            margin: 10px 0; 
            padding: 10px; 
            border-radius: 5px; 
            display: none;
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .step { margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”— Supabase + Netlify æ•´åˆæ¸¬è©¦</h1>
        <p>é€™å€‹é é¢å°‡æ¸¬è©¦æ‚¨çš„ Supabase è³‡æ–™åº«æ˜¯å¦æ­£ç¢ºé€£æ¥åˆ° Netlify éƒ¨ç½²çš„ç¶²ç«™ã€‚</p>

        <!-- æ¸¬è©¦1: åŸºæœ¬é€£æ¥æ¸¬è©¦ -->
        <div class="test-section">
            <h3>1. åŸºæœ¬é€£æ¥æ¸¬è©¦</h3>
            <div class="step">
                <button onclick="testConnection()">æ¸¬è©¦ Supabase é€£æ¥</button>
                <div id="connection-result" class="result"></div>
            </div>
        </div>

        <!-- æ¸¬è©¦2: èªè­‰åŠŸèƒ½æ¸¬è©¦ -->
        <div class="test-section">
            <h3>2. èªè­‰åŠŸèƒ½æ¸¬è©¦</h3>
            <div class="step">
                <input type="email" id="test-email" placeholder="æ¸¬è©¦éƒµç®±" value="test@example.com" style="padding: 8px; width: 200px;">
                <input type="password" id="test-password" placeholder="æ¸¬è©¦å¯†ç¢¼" value="test123456" style="padding: 8px; width: 200px;">
                <button onclick="testAuth()">æ¸¬è©¦è¨»å†Š/ç™»å…¥</button>
                <div id="auth-result" class="result"></div>
            </div>
        </div>

        <!-- æ¸¬è©¦3: è³‡æ–™åº«æ“ä½œæ¸¬è©¦ -->
        <div class="test-section">
            <h3>3. è³‡æ–™åº«æ“ä½œæ¸¬è©¦</h3>
            <div class="step">
                <button onclick="testDatabase()">æ¸¬è©¦è³‡æ–™åº«è®€å¯«</button>
                <div id="database-result" class="result"></div>
            </div>
        </div>

        <!-- æ¸¬è©¦4: ç’°å¢ƒè®Šæ•¸æ¸¬è©¦ -->
        <div class="test-section">
            <h3>4. ç’°å¢ƒé…ç½®æª¢æŸ¥</h3>
            <div class="step">
                <button onclick="checkEnvironment()">æª¢æŸ¥ç’°å¢ƒé…ç½®</button>
                <div id="environment-result" class="result"></div>
            </div>
        </div>

        <!-- æ¸¬è©¦çµæœç¸½çµ -->
        <div class="test-section">
            <h3>ğŸ“Š æ¸¬è©¦çµæœç¸½çµ</h3>
            <div id="summary-result" class="result info">
                é»æ“Šä¸Šæ–¹æŒ‰éˆ•é–‹å§‹æ¸¬è©¦...
            </div>
            <button onclick="runAllTests()" style="background: #27ae60;">åŸ·è¡Œæ‰€æœ‰æ¸¬è©¦</button>
        </div>
    </div>

    <!-- å¼•å…¥ Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // ğŸ”§ é…ç½® - è«‹æ›¿æ›ç‚ºæ‚¨çš„å¯¦éš›å€¼
        const SUPABASE_CONFIG = {
            url: 'https://fayorxvfxtrycjiiiyfu.supabase.co',
            key: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZheW9yeHZmeHRyeWNqaWlpeWZ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyNzY1MTAsImV4cCI6MjA3OTg1MjUxMH0.7znE_AaNg6zESUO-RoSsyFqxCgcxjPT_pQiN557e6Nw'
        };

        // åˆå§‹åŒ– Supabase å®¢æˆ¶ç«¯
        const supabase = supabase.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.key, {
            auth: {
                autoRefreshToken: true,
                persistSession: true,
                detectSessionInUrl: true
            }
        });

        let testResults = {
            connection: false,
            auth: false,
            database: false,
            environment: false
        };

        // é¡¯ç¤ºæ¸¬è©¦çµæœ
        function showResult(elementId, message, isSuccess) {
            const element = document.getElementById(elementId);
            element.innerHTML = message;
            element.className = `result ${isSuccess ? 'success' : 'error'}`;
            element.style.display = 'block';
        }

        // æ¸¬è©¦1: åŸºæœ¬é€£æ¥
        async function testConnection() {
            showResult('connection-result', 'ğŸ”„ æ¸¬è©¦é€£æ¥ä¸­...', true);
            
            try {
                // å˜—è©¦ç°¡å–®çš„æŸ¥è©¢ä¾†æ¸¬è©¦é€£æ¥
                const { data, error } = await supabase.from('_dummy_table_').select('*').limit(1);
                
                if (error && error.code === '42P01') {
                    // è¡¨ä¸å­˜åœ¨éŒ¯èª¤ - é€™å¯¦éš›ä¸Šè¡¨ç¤ºé€£æ¥æˆåŠŸï¼
                    showResult('connection-result', 'âœ… é€£æ¥æˆåŠŸï¼Supabase éŸ¿æ‡‰æ­£å¸¸ã€‚', true);
                    testResults.connection = true;
                } else if (error) {
                    showResult('connection-result', `âŒ é€£æ¥éŒ¯èª¤: ${error.message}`, false);
                    testResults.connection = false;
                } else {
                    showResult('connection-result', 'âœ… é€£æ¥æˆåŠŸï¼', true);
                    testResults.connection = true;
                }
            } catch (error) {
                showResult('connection-result', `âŒ é€£æ¥ç•°å¸¸: ${error.message}`, false);
                testResults.connection = false;
            }
            
            updateSummary();
        }

        // æ¸¬è©¦2: èªè­‰åŠŸèƒ½
        async function testAuth() {
            const email = document.getElementById('test-email').value;
            const password = document.getElementById('test-password').value;
            
            showResult('auth-result', 'ğŸ”„ æ¸¬è©¦èªè­‰åŠŸèƒ½ä¸­...', true);
            
            try {
                // å˜—è©¦è¨»å†Šæ–°ç”¨æˆ¶
                const { data: signUpData, error: signUpError } = await supabase.auth.signUp({
                    email: email,
                    password: password,
                });

                if (signUpError) {
                    if (signUpError.message.includes('already registered')) {
                        // ç”¨æˆ¶å·²å­˜åœ¨ï¼Œå˜—è©¦ç™»å…¥
                        const { data: signInData, error: signInError } = await supabase.auth.signInWithPassword({
                            email: email,
                            password: password,
                        });

                        if (signInError) {
                            showResult('auth-result', `âŒ ç™»å…¥å¤±æ•—: ${signInError.message}`, false);
                            testResults.auth = false;
                        } else {
                            showResult('auth-result', 'âœ… èªè­‰æˆåŠŸï¼ç”¨æˆ¶å·²ç™»å…¥ã€‚', true);
                            testResults.auth = true;
                        }
                    } else {
                        showResult('auth-result', `âŒ è¨»å†Šå¤±æ•—: ${signUpError.message}`, false);
                        testResults.auth = false;
                    }
                } else {
                    showResult('auth-result', 'âœ… è¨»å†ŠæˆåŠŸï¼è«‹æª¢æŸ¥éƒµç®±ç¢ºèªã€‚', true);
                    testResults.auth = true;
                }
            } catch (error) {
                showResult('auth-result', `âŒ èªè­‰ç•°å¸¸: ${error.message}`, false);
                testResults.auth = false;
            }
            
            updateSummary();
        }

        // æ¸¬è©¦3: è³‡æ–™åº«æ“ä½œ
        async function testDatabase() {
            showResult('database-result', 'ğŸ”„ æ¸¬è©¦è³‡æ–™åº«æ“ä½œä¸­...', true);
            
            try {
                // é¦–å…ˆæª¢æŸ¥å¿…è¦çš„è¡¨æ˜¯å¦å­˜åœ¨
                const { data: tables, error: tablesError } = await supabase
                    .from('information_schema.tables')
                    .select('table_name')
                    .eq('table_schema', 'public')
                    .limit(5);

                if (tablesError) {
                    showResult('database-result', `âš ï¸ ç„¡æ³•è®€å–è¡¨ä¿¡æ¯: ${tablesError.message}`, false);
                } else {
                    let message = 'âœ… è³‡æ–™åº«å¯è¨ªå•ã€‚<br>ç¾æœ‰è¡¨: ';
                    if (tables && tables.length > 0) {
                        message += tables.map(t => t.table_name).join(', ');
                    } else {
                        message += 'ç„¡è¡¨æˆ–ç„¡æ¬Šé™è¨ªå•';
                    }
                    showResult('database-result', message, true);
                    testResults.database = true;
                }
            } catch (error) {
                showResult('database-result', `âŒ è³‡æ–™åº«æ“ä½œç•°å¸¸: ${error.message}`, false);
                testResults.database = false;
            }
            
            updateSummary();
        }

        // æ¸¬è©¦4: ç’°å¢ƒé…ç½®
        async function checkEnvironment() {
            showResult('environment-result', 'ğŸ”„ æª¢æŸ¥ç’°å¢ƒé…ç½®ä¸­...', true);
            
            try {
                const configInfo = `
                    <strong>ç•¶å‰é…ç½®:</strong><br>
                    - Supabase URL: ${SUPABASE_CONFIG.url ? 'âœ… å·²è¨­ç½®' : 'âŒ æœªè¨­ç½®'}<br>
                    - Supabase Key: ${SUPABASE_CONFIG.key ? 'âœ… å·²è¨­ç½®' : 'âŒ æœªè¨­ç½®'}<br>
                    - ç•¶å‰åŸŸå: ${window.location.hostname}<br>
                    - å”è­°: ${window.location.protocol}
                `;
                
                // æª¢æŸ¥æ˜¯å¦åœ¨ Netlify ä¸Šé‹è¡Œ
                const isNetlify = window.location.hostname.includes('netlify.app');
                const netlifyInfo = isNetlify ? 'âœ… é‹è¡Œåœ¨ Netlify' : 'âš ï¸ æœªé‹è¡Œåœ¨ Netlify';
                
                showResult('environment-result', `${configInfo}<br>${netlifyInfo}`, true);
                testResults.environment = true;
            } catch (error) {
                showResult('environment-result', `âŒ ç’°å¢ƒæª¢æŸ¥ç•°å¸¸: ${error.message}`, false);
                testResults.environment = false;
            }
            
            updateSummary();
        }

        // æ›´æ–°æ¸¬è©¦ç¸½çµ
        function updateSummary() {
            const passed = Object.values(testResults).filter(Boolean).length;
            const total = Object.keys(testResults).length;
            const percentage = Math.round((passed / total) * 100);
            
            let summaryHTML = `
                <strong>æ¸¬è©¦é€²åº¦: ${passed}/${total} (${percentage}%)</strong><br>
                <ul>
                    <li>${testResults.connection ? 'âœ…' : 'âŒ'} åŸºæœ¬é€£æ¥æ¸¬è©¦</li>
                    <li>${testResults.auth ? 'âœ…' : 'âŒ'} èªè­‰åŠŸèƒ½æ¸¬è©¦</li>
                    <li>${testResults.database ? 'âœ…' : 'âŒ'} è³‡æ–™åº«æ“ä½œæ¸¬è©¦</li>
                    <li>${testResults.environment ? 'âœ…' : 'âŒ'} ç’°å¢ƒé…ç½®æª¢æŸ¥</li>
                </ul>
            `;
            
            if (percentage === 100) {
                summaryHTML += '<br>ğŸ‰ æ‰€æœ‰æ¸¬è©¦é€šéï¼æ‚¨çš„ Supabase + Netlify æ•´åˆæˆåŠŸï¼';
            } else if (percentage >= 50) {
                summaryHTML += '<br>âš ï¸ éƒ¨åˆ†æ¸¬è©¦é€šéï¼Œè«‹æª¢æŸ¥å¤±æ•—çš„é …ç›®ã€‚';
            } else {
                summaryHTML += '<br>âŒ å¤šæ•¸æ¸¬è©¦å¤±æ•—ï¼Œè«‹æª¢æŸ¥é…ç½®ã€‚';
            }
            
            document.getElementById('summary-result').innerHTML = summaryHTML;
        }

        // åŸ·è¡Œæ‰€æœ‰æ¸¬è©¦
        async function runAllTests() {
            await testConnection();
            await testAuth();
            await testDatabase();
            await checkEnvironment();
        }

        // é é¢åŠ è¼‰æ™‚è‡ªå‹•æª¢æŸ¥ç’°å¢ƒ
        document.addEventListener('DOMContentLoaded', function() {
            checkEnvironment();
        });
    </script>
</body>
</html>
