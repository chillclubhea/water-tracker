<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase é€£æ¥æ¸¬è©¦ - ä¿®æ­£ç‰ˆ</title>
    <!-- å…ˆåŠ è¼‰ Supabase åº« -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: 50px auto; padding: 20px; }
        .test-area { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
        button { padding: 10px 15px; margin: 5px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #2980b9; }
        button:disabled { background: #95a5a6; cursor: not-allowed; }
        .result { padding: 10px; margin: 10px 0; border-radius: 5px; display: none; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .loading { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        input { padding: 8px; margin: 5px; border: 1px solid #ddd; border-radius: 4px; width: 200px; }
    </style>
</head>
<body>
    <h1>ğŸ”— Supabase é€£æ¥æ¸¬è©¦</h1>
    
    <div class="test-area">
        <h3>ğŸ“‹ ç’°å¢ƒè³‡è¨Š</h3>
        <div id="env-info" class="result info"></div>
    </div>
    
    <div class="test-area">
        <h3>ğŸ”Œ é€£æ¥æ¸¬è©¦</h3>
        <button id="test-connection-btn" onclick="handleTestConnection()">æ¸¬è©¦é€£æ¥</button>
        <div id="connection-result" class="result"></div>
    </div>
    
    <div class="test-area">
        <h3>ğŸ” èªè­‰æ¸¬è©¦</h3>
        <div>
            <input type="email" id="test-email" placeholder="test@example.com" value="test@example.com">
            <input type="password" id="test-pwd" placeholder="å¯†ç¢¼" value="test123456">
            <button onclick="handleTestAuth()">æ¸¬è©¦èªè­‰</button>
        </div>
        <div id="auth-result" class="result"></div>
    </div>

    <script>
        // ==================== é…ç½®å€åŸŸ ====================
        // è«‹æ›¿æ›ç‚ºæ‚¨çš„å¯¦éš› Supabase é …ç›®ä¿¡æ¯
        const SUPABASE_CONFIG = {
            url: 'https://fayorxvfxtrycjiiiyfu.supabase.co',  // æ›¿æ›ç‚ºæ‚¨çš„ URL
            key: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZheW9yeHZmeHRyeWNqaWlpeWZ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyNzY1MTAsImV4cCI6MjA3OTg1MjUxMH0.7znE_AaNg6zESUO-RoSsyFqxCgcxjPT_pQiN557e6Nw
'                      // æ›¿æ›ç‚ºæ‚¨çš„ anon key
        };

        // ==================== Supabase åˆå§‹åŒ– ====================
        console.log('ğŸ”„ åˆå§‹åŒ– Supabase...');
        
        // æª¢æŸ¥ Supabase åº«æ˜¯å¦åŠ è¼‰
        if (typeof supabase === 'undefined') {
            console.error('âŒ Supabase JS åº«æœªæ­£ç¢ºåŠ è¼‰');
            document.getElementById('env-info').innerHTML = 
                'âŒ Supabase JS åº«æœªåŠ è¼‰ï¼Œè«‹æª¢æŸ¥ç¶²çµ¡é€£æ¥';
            document.getElementById('env-info').className = 'result error';
            document.getElementById('env-info').style.display = 'block';
        } else {
            console.log('âœ… Supabase JS åº«å·²åŠ è¼‰');
        }

        // åˆå§‹åŒ– Supabase å®¢æˆ¶ç«¯
        let supabaseClient;
        try {
            supabaseClient = supabase.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.key, {
                auth: {
                    autoRefreshToken: true,
                    persistSession: true,
                    detectSessionInUrl: true
                }
            });
            console.log('âœ… Supabase å®¢æˆ¶ç«¯åˆå§‹åŒ–æˆåŠŸ');
        } catch (error) {
            console.error('âŒ Supabase åˆå§‹åŒ–å¤±æ•—:', error);
        }

        // ==================== å·¥å…·å‡½æ•¸ ====================
        
        // é¡¯ç¤ºçµæœ
        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = message;
            element.className = `result ${type}`;
            element.style.display = 'block';
        }

        // é©—è­‰é…ç½®
        function validateConfig() {
            if (!SUPABASE_CONFIG.url || SUPABASE_CONFIG.url === 'https://æ‚¨çš„é …ç›®ç·¨è™Ÿ.supabase.co') {
                showResult('env-info', 'âŒ è«‹å…ˆé…ç½® Supabase URL', 'error');
                return false;
            }
            if (!SUPABASE_CONFIG.key || SUPABASE_CONFIG.key === 'æ‚¨çš„-anon-key') {
                showResult('env-info', 'âŒ è«‹å…ˆé…ç½® Supabase Key', 'error');
                return false;
            }
            if (!SUPABASE_CONFIG.url.includes('.supabase.co')) {
                showResult('env-info', 'âŒ Supabase URL æ ¼å¼ä¸æ­£ç¢º', 'error');
                return false;
            }
            return true;
        }

        // ==================== æ¸¬è©¦å‡½æ•¸ ====================
        
        // é€£æ¥æ¸¬è©¦è™•ç†å‡½æ•¸
        async function handleTestConnection() {
            const btn = document.getElementById('test-connection-btn');
            btn.disabled = true;
            btn.textContent = 'æ¸¬è©¦ä¸­...';
            
            // å…ˆé©—è­‰é…ç½®
            if (!validateConfig()) {
                btn.disabled = false;
                btn.textContent = 'æ¸¬è©¦é€£æ¥';
                return;
            }

            showResult('connection-result', 'ğŸ”„ æ­£åœ¨æ¸¬è©¦ Supabase é€£æ¥...', 'loading');
            
            try {
                // æ¸¬è©¦æ–¹æ³•ï¼šå˜—è©¦æŸ¥è©¢ä¸€å€‹ä¸å­˜åœ¨çš„è¡¨
                // å¦‚æœé€£æ¥æˆåŠŸï¼Œæœƒè¿”å›è¡¨ä¸å­˜åœ¨çš„éŒ¯èª¤
                // å¦‚æœé€£æ¥å¤±æ•—ï¼Œæœƒè¿”å›ç¶²çµ¡éŒ¯èª¤
                const { data, error } = await supabaseClient
                    .from('_test_connection_table_')
                    .select('*')
                    .limit(1);
                
                if (error) {
                    if (error.code === '42P01') {
                        // è¡¨ä¸å­˜åœ¨éŒ¯èª¤ - é€™è¡¨ç¤ºé€£æ¥å¯¦éš›ä¸Šæ˜¯æˆåŠŸçš„ï¼
                        showResult('connection-result', 
                            'âœ… é€£æ¥æˆåŠŸï¼<br>' +
                            'Supabase æœå‹™æ­£å¸¸éŸ¿æ‡‰<br>' +
                            'éŒ¯èª¤é¡å‹: è¡¨ä¸å­˜åœ¨ (é€™åœ¨é€£æ¥æ¸¬è©¦ä¸­æ˜¯æ­£å¸¸çš„)', 
                            'success');
                    } else if (error.code === '42501') {
                        showResult('connection-result', 
                            'âœ… é€£æ¥æˆåŠŸï¼<br>' +
                            'Supabase æœå‹™æ­£å¸¸éŸ¿æ‡‰<br>' +
                            'éŒ¯èª¤é¡å‹: æ¬Šé™ä¸è¶³', 
                            'success');
                    } else {
                        showResult('connection-result', 
                            `âš ï¸ é€£æ¥éŸ¿æ‡‰ç•°å¸¸<br>éŒ¯èª¤: ${error.message}<br>ä»£ç¢¼: ${error.code}`, 
                            'error');
                    }
                } else {
                    showResult('connection-result', 
                        'âœ… é€£æ¥æˆåŠŸï¼<br>Supabase æœå‹™æ­£å¸¸éŸ¿æ‡‰', 
                        'success');
                }
            } catch (err) {
                showResult('connection-result', 
                    `âŒ é€£æ¥å¤±æ•—<br>éŒ¯èª¤: ${err.message}<br>` +
                    'è«‹æª¢æŸ¥: <br>' +
                    '1. Supabase URL å’Œ Key æ˜¯å¦æ­£ç¢º<br>' +
                    '2. ç¶²çµ¡é€£æ¥æ˜¯å¦æ­£å¸¸<br>' +
                    '3. Supabase é …ç›®æ˜¯å¦å•Ÿå‹•', 
                    'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'æ¸¬è©¦é€£æ¥';
            }
        }

        // èªè­‰æ¸¬è©¦è™•ç†å‡½æ•¸
        async function handleTestAuth() {
            const email = document.getElementById('test-email').value;
            const password = document.getElementById('test-pwd').value;
            
            if (!email || !password) {
                showResult('auth-result', 'âŒ è«‹è¼¸å…¥éƒµç®±å’Œå¯†ç¢¼', 'error');
                return;
            }

            if (!validateConfig()) {
                return;
            }

            showResult('auth-result', 'ğŸ”„ æ­£åœ¨æ¸¬è©¦èªè­‰åŠŸèƒ½...', 'loading');
            
            try {
                // å…ˆå˜—è©¦è¨»å†Š
                const { data, error } = await supabaseClient.auth.signUp({
                    email: email,
                    password: password
                });

                if (error) {
                    if (error.message.includes('already registered') || 
                        error.message.includes('User already registered')) {
                        // ç”¨æˆ¶å·²å­˜åœ¨ï¼Œå˜—è©¦ç™»å…¥
                        const { data: signInData, error: signInError } = await supabaseClient.auth.signInWithPassword({
                            email: email,
                            password: password
                        });
                        
                        if (signInError) {
                            showResult('auth-result', 
                                `âŒ ç™»å…¥å¤±æ•—<br>éŒ¯èª¤: ${signInError.message}`, 
                                'error');
                        } else {
                            showResult('auth-result', 
                                'âœ… ç™»å…¥æˆåŠŸï¼<br>èªè­‰åŠŸèƒ½æ­£å¸¸<br>' +
                                `ç”¨æˆ¶: ${signInData.user.email}`, 
                                'success');
                        }
                    } else {
                        showResult('auth-result', 
                            `âŒ è¨»å†Šå¤±æ•—<br>éŒ¯èª¤: ${error.message}`, 
                            'error');
                    }
                } else {
                    if (data.user && data.session) {
                        showResult('auth-result', 
                            'âœ… è¨»å†Šä¸¦è‡ªå‹•ç™»å…¥æˆåŠŸï¼<br>èªè­‰åŠŸèƒ½æ­£å¸¸', 
                            'success');
                    } else if (data.user && !data.session) {
                        showResult('auth-result', 
                            'âœ… è¨»å†ŠæˆåŠŸï¼<br>è«‹æª¢æŸ¥éƒµç®±ç¢ºèªå¸³è™Ÿ<br>èªè­‰åŠŸèƒ½æ­£å¸¸', 
                            'success');
                    } else {
                        showResult('auth-result', 
                            'âœ… è¨»å†Šè«‹æ±‚å·²ç™¼é€<br>èªè­‰åŠŸèƒ½æ­£å¸¸', 
                            'success');
                    }
                }
            } catch (err) {
                showResult('auth-result', 
                    `âŒ èªè­‰ç•°å¸¸<br>éŒ¯èª¤: ${err.message}`, 
                    'error');
            }
        }

        // ==================== é é¢åˆå§‹åŒ– ====================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ é é¢åˆå§‹åŒ–å®Œæˆ');
            
            // é¡¯ç¤ºç’°å¢ƒä¿¡æ¯
            const envInfo = `
                <strong>ç’°å¢ƒä¿¡æ¯:</strong><br>
                - ç•¶å‰åŸŸå: ${window.location.hostname}<br>
                - å”è­°: ${window.location.protocol}<br>
                - Supabase åº«: ${typeof supabase !== 'undefined' ? 'âœ… å·²åŠ è¼‰' : 'âŒ æœªåŠ è¼‰'}<br>
                - å®¢æˆ¶ç«¯: ${supabaseClient ? 'âœ… å·²åˆå§‹åŒ–' : 'âŒ æœªåˆå§‹åŒ–'}<br>
                - é…ç½®: ${validateConfig() ? 'âœ… æœ‰æ•ˆ' : 'âŒ éœ€è¦é…ç½®'}
            `;
            
            showResult('env-info', envInfo, 'info');
            
            // å¦‚æœé…ç½®ç„¡æ•ˆï¼Œé¡¯ç¤ºæç¤º
            if (!validateConfig()) {
                showResult('env-info', 
                    'âŒ è«‹å…ˆé…ç½® Supabase<br>' +
                    '1. æ›¿æ› SUPABASE_CONFIG ä¸­çš„ URL å’Œ Key<br>' +
                    '2. ç¢ºä¿ä½¿ç”¨æ­£ç¢ºçš„ anon public key<br>' +
                    '3. ç¢ºä¿é …ç›® URL æ ¼å¼æ­£ç¢º', 
                    'error');
            }
        });

    </script>
</body>
</html>
